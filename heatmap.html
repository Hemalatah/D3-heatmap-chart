<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="css/custom.css"> 
    <!-- d3.js link -->
    <script src="http://d3js.org/d3.v3.js"></script>
    <!-- jQuery CDN -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <!-- Bootstrap Js CDN -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- d3-tip package -->
    <script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
    <script src="script.js"></script>
  </head>
  <body>
    <div class="wrapper">
      <div id="mainbar">
          <h3>Main Heading TBD</h3>
      </div>
      <nav id="sidebar">
          <div id="sidebar-header">
            <h4>Nav Header</h4>
          </div>
          <!-- Sidebar Links -->
          <ul class="list-unstyled components">
              <li>
                  <a href="#instance1Submenu" data-toggle="collapse" aria-expanded="false">FSL_Instance1</a>
                  <ul class="collapse list-unstyled" id="instance1Submenu">
                      <li>
                          <a href="#">Profile_0</a></li>
                      <li><a href="#">Profile_1</a></li>
                      <li><a href="#">Profile_2</a></li>
                  </ul>
              </li>
              <li>
                  <a href="#instance2Submenu" data-toggle="collapse" aria-expanded="false">FSL_Instance2</a>
                  <ul class="collapse list-unstyled" id="instance2Submenu">
                      <li>
                          <a href="#">Profile_0</a></li>
                      <li><a href="#">Profile_1</a></li>
                      <li><a href="#">Profile_2</a></li>
                  </ul></li>
              <li>
                  <a href="#instance3Submenu" data-toggle="collapse" aria-expanded="false">FSL_Instance3</a>
                  <ul class="collapse list-unstyled" id="instance3Submenu">
                      <li>
                          <a href="#">Profile_0</a></li>
                      <li><a href="#">Profile_1</a></li>
                      <li><a href="#">Profile_2</a></li>
                  </ul>
                </li>
              <li>
                  <a href="#instance4Submenu" data-toggle="collapse" aria-expanded="false">FSL_Instance4</a>
                  <ul class="collapse list-unstyled" id="instance4Submenu">
                      <li>
                          <a href="#">Profile_0</a></li>
                      <li><a href="#">Profile_1</a></li>
                      <li><a href="#">Profile_2</a></li>
                  </ul>
                </li>
          </ul>
      </nav> 
      <div id="chart"></div>
      <div id="legend"></div>
      <!--<div id="dataset-picker"></div>-->
    </div>
    <script type="text/javascript">
      var margin = { top: 100, right: 0, bottom: 100, left: 150 },
          width = 650 - margin.left - margin.right,
          height = 700 - margin.top - margin.bottom,
          gridSize = Math.floor(width / 10),
          buckets = 10,
          colors = ["#60B660","#42B881","#6AC1A5","#ACDCA6","#E6F49D","#F6F9AE","#FDDF90","#F26E4A","#D34052","#9C0843"], // alternatively colorbrewer.YlGnBu[9]
          yLabel = ["floor_0", "floor_1", "floor_2", "floor_3", "floor_4", "floor_5", "floor_6", "floor_7", "floor_8"],
          xLabel = ['CTRL_Bus', 'DATA_Bus', 'LUT', "CAPU"],
          xsubLabel = ["Main", "Passthru","Main","Passthru","LUT_0","LUT_1","CAPU_8","CAPU_16","DAPU","DDPU"],
          ysubLabel = ['half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1', 'half_0', 'half_1'];

      var colorScale = d3.scale.quantile()
          .domain([0, 100])
          .range(colors);


      var svg = d3.select("#chart").append("svg")
          .attr("width", width + margin.left + margin.right + 50)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var yLabels = svg.selectAll(".yLabel")
          .data(yLabel)
          .enter().append("text")
            .text(function (d) { return d; })
            .attr("x", -50)
            .attr("y", function (d, i) { return i * gridSize + 20; })
            .style("text-anchor", "end")
            .attr("transform", "translate(-6," + gridSize / 1.7 + ")")
            .attr("class", "yLabel mono axis axis-workweek");

      var ysubLabels = svg.selectAll(".ysubLabel")
          .data(ysubLabel)
          .enter().append("text")
            .text(function (d) { return d; })
            .attr("class", "mono")
            .attr("x", 10)
            .attr("y", function (d, i) { return i * gridSize/2 + 20; })
            .style("text-anchor", "end")
            .attr("transform", "translate(-6," + gridSize / 3 + ")")
            //.attr("class", "yLabel mono axis axis-workweek");

      var xLabels = svg.selectAll(".xLabel")
          .data(xLabel)
          .enter().append("text")
            .text(function(d) { return d; })
            .attr("x", function(xLabel, i) { return i * 2 * gridSize +40; })
            .attr("y", 0)
            .style("text-anchor", "middle")
            .attr("transform", "translate(" + gridSize / 2 + ", -6)")
            .attr("class", "xLabel mono axis axis-worktime");

      var xsubLabels = svg.selectAll(".xsubLabel")
          .data(xsubLabel)
          .enter().append("text")
            .text(function(d) { return d; })
            .attr("class", "mono")
            .attr("x", function(d, i) { return i * gridSize +10; })
            .attr("y", 20)
            .style("text-anchor", "middle")
            .attr("transform", "translate(" + gridSize / 2 + ", -6)")
            //.attr("class", "xLabel mono axis axis-worktime");

      var svg1 = d3.select("#legend").append("svg")
          .attr("width", gridSize*4)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + 70 + "," + margin.top + ")");

      var legend = svg1.selectAll(".legend")
          .data([0].concat(colorScale.quantiles()), function(d) { return d; });

      legend.enter().append("g")
          .attr("class", "legend");

      legend.append("rect")
        .attr("x", 0)
        .attr("y", function(colors, i) { return gridSize/2 * i; })
        .attr("width", gridSize/2)
        .attr("height", gridSize/2)
        .style("fill", function(d, i) { return colors[i]; });

      legend.append("text")
        .attr("class", "mono")
        .text(function(d,i) { return "≥ " + Math.round(i*10); })
        .attr("x", gridSize)
        .attr("y", function(colors, i) { return (gridSize/2 * i)+gridSize/3; });

      legend.exit().remove();

          
      // Adding x-axis label based on the given json
      function get_floor_values(current_instance) {
        var xValues = [];
        var current_profile = Object.values(current_instance);
        var floors = Object.keys(current_instance);
        for(var j = 0; j < current_profile.length; j++) {
          var current_floor = Object.values(current_profile[j]);
          var half_floors = Object.keys(current_profile[j]);
          for(var k = 0; k < current_floor.length; k++) {
            var current_half_floor = Object.values(current_floor[k]);
            var current_xLabel = [];
            (Object.values(current_half_floor[0].CTRL)).forEach(function(val) {
              current_xLabel.push(val);
            });
            (Object.values(current_half_floor[0].DATA)).forEach(function(val) {
              current_xLabel.push(val);
            });
            current_xLabel.push(current_half_floor[1].LUT_0, current_half_floor[1].LUT_1, current_half_floor[2].CAPU_8, current_half_floor[2].CAPU_16, current_half_floor[2].DAPU, current_half_floor[2].DDPU);
            xValues.push(current_xLabel); 
          }
        }
        return xValues;
      }

      d3.json('data.json', function(d) {
        var instances = Object.keys(d.FSL);
        for(var i = 0; i < instances.length; i++) {
          if(instances[i] == 'Ins1') {
            var current_instance = Object.values(d.FSL[instances[i]]);
            var profiles = Object.keys(d.FSL[instances[i]]);
            for(var m = 0; m < current_instance.length; m++) {
              if(profiles[m] == 'profile_1') {
                var xValues = get_floor_values(current_instance[m]);
                var jso = [], jso_val;
                xValues.forEach(function(d,i) {
                  for(j = 0; j < d.length; j++) {
                    jso_val = { floor : i,
                                interfaces: j,
                                half_floor : (i % 2) ? 1 : 0,
                                value : d[j]
                              }
                    jso.push(jso_val);
                  }
                });
                // console.log(jso); 
                // console.log(d.interfaces);
                console.log(jso);
                

                // Prep the tooltip bits, initial display is hidden
                var tip = d3.tip()
                  .attr('class', 'd3-tip')
                  .html(function(d) {
                    return "<span style='color:#333'>Available:" + (100 - d.value) + "%</span>";
                  })

                svg.call(tip);

                var cards = svg.selectAll(".hour")
                    .data(jso, function(d) {return d.floor+':'+d.interfaces;});

                cards.append("title");
               
                cards.enter().append("rect")
                    .attr("x", function(d) { return (d.interfaces) * gridSize + 10; })
                    .attr("y", function(d) { return (d.floor) * gridSize/2 + 20; })
                    .attr('id', function(d) { return ("box" + d.floor + d.interfaces); })
                    .attr("rx", 2)
                    .attr("ry", 2)
                    .attr("class", "hour bordered")
                    .attr("width", gridSize/3)
                    .attr("height", gridSize/5)
                    .style("fill", function(d) { return colors[Math.floor(d.value/10)]; })
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide);

                          
                cards.transition()
                    .style("fill", function(d) { return colorScale(d.value); })
                    .attr("rx", 4)
                    .attr("ry", 4)
                    .attr("width", gridSize)
                    .attr("height", gridSize/2)
                    .delay(200)
                    .duration(1000)
                    .ease("linear");

                cards.select("title").text(function(d) { return d.value; });

                cards.exit().remove();
              }
            }
          }
        }
      });
      datasets = ["tsvFile/data.tsv", "tsvFile/data2.tsv"];
      
      /*var heatmapChart = function(tsvFile) {
        d3.tsv("data1.tsv",
        function(d) {
          return {
            half_floor: +d.half_floor,
            floor: +d.floor,
            interfaces: +d.interfaces,
            value: +d.value
          };
        },
        function(error, data) {
          console.log(data);
          var colorScale = d3.scale.quantile()
              .domain([0, (buckets - 1), d3.max(data, function (d) { return d.value; })])
              .range(colors);

          // Prep the tooltip bits, initial display is hidden
          var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([7, 0])
            .html(function(d) {
              return "<span style='color:#333'>Value:" + d.value + "</span>";
            })

          svg.call(tip);

          var cards = svg.selectAll(".hour")
              .data(data, function(d) {return d.floor+':'+d.interfaces;});

          cards.append("title");
         
          cards.enter().append("rect")
              .attr("x", function(d) { return (d.interfaces - 1) * gridSize; })
              .attr("y", function(d) { return (d.floor) * gridSize/2; })
              .attr('id', function(d) { return ("box" + d.floor + d.interfaces); })
              .attr("rx", 4)
              .attr("ry", 4)
              .attr("class", "hour bordered")
              .attr("width", gridSize)
              .attr("height", gridSize/2)
              .style("fill", function(d) { return colors[Math.floor(d.value/10)]; })
              .on('mouseover', tip.show)
              .on('mouseout', tip.hide);

                    
          cards.transition().duration(1000)
              .style("fill", function(d) { return colorScale(d.value); });

          cards.select("title").text(function(d) { return d.value; });
          
          cards.on("mouseover", function(d) {
            if(this.id == "box"+ d.floor + d.interfaces) {
              d3.select("#"+this.id).style("transform", 'scale(0.98)').style("transition", "all 200ms ease-in");
            }
          }).on("mouseout", function(d) {
            if(this.id == "box"+ d.floor + d.interfaces) {
              d3.select("#"+this.id).style("transform", 'scale(1)').style("transition", "all 200ms ease-in");
            }
          });

          cards.exit().remove();

          var legend = svg.selectAll(".legend")
              .data([0].concat(colorScale.quantiles()), function(d) { return d; });

          legend.enter().append("g")
              .attr("class", "legend");

          legend.append("rect")
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height)
            .attr("width", legendElementWidth)
            .attr("height", gridSize / 2)
            .style("fill", function(d, i) { return colors[i]; });

          legend.append("text")
            .attr("class", "mono")
            .text(function(d,i) { return "≥ " + Math.round(i*10); })
            .attr("x", function(d, i) { return legendElementWidth * i; })
            .attr("y", height + gridSize);

          legend.exit().remove();

        });  
      };

      heatmapChart(datasets[0]);*/
      
      var datasetpicker = d3.select("#dataset-picker").selectAll(".dataset-button")
        .data(datasets);

      datasetpicker.enter()
        .append("input")
        .attr("value", function(d){ return "Dataset " + d })
        .attr("type", "button")
        .attr("class", "dataset-button")
        .on("click", function(d) {
          heatmapChart(d);
        });
    </script>
  </body>
</html>
